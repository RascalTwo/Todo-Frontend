var e=Object.defineProperty,t=Object.defineProperties,n=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,l=(t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r,s=(e,t)=>{for(var n in t||(t={}))o.call(t,n)&&l(e,n,t[n]);if(r)for(var n of r(t))a.call(t,n)&&l(e,n,t[n]);return e},c=(e,r)=>t(e,n(r));import{m as d,r as i,R as u,P as m,T as p,I as f,a as h,d as E,u as x,c as b,b as g,e as v,C as O,f as w,g as T,h as S,E as y,i as k,j as C,k as P,B as $,l as I,n as N,L as D,o as L}from"./vendor.b8ad11ef.js";let j;const J={},M=function(e,t){if(!t||0===t.length)return e();if(void 0===j){const e=document.createElement("link").relList;j=e&&e.supports&&e.supports("modulepreload")?"modulepreload":"preload"}return Promise.all(t.map((e=>{if(e in J)return;J[e]=!0;const t=e.endsWith(".css"),n=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${e}"]${n}`))return;const r=document.createElement("link");return r.rel=t?"stylesheet":j,t||(r.as="script",r.crossOrigin=""),r.href=e,document.head.appendChild(r),t?new Promise(((e,t)=>{r.addEventListener("load",e),r.addEventListener("error",t)})):void 0}))).then((()=>e()))},_=d({form:{display:"flex",padding:"0.5em"},input:{flex:"1"},helperText:{position:"absolute",right:"4em",top:0,pointerEvents:"none"}});function B(e){var t=e,{onSubmission:n,children:l,IconButtonProps:c,resetOnSuccess:d=!0}=t,E=((e,t)=>{var n={};for(var l in e)o.call(e,l)&&t.indexOf(l)<0&&(n[l]=e[l]);if(null!=e&&r)for(var l of r(e))t.indexOf(l)<0&&a.call(e,l)&&(n[l]=e[l]);return n})(t,["onSubmission","children","IconButtonProps","resetOnSuccess"]);const x=_(),[b,g]=i.exports.useState();return u.createElement(m,{component:"form",className:x.form,onSubmit:i.exports.useCallback((async e=>{e.preventDefault();const t=e.target.elements[0];try{await n(t.value),d&&e.target.reset(),g(void 0)}catch(r){g(r.message)}}),[d,n,g])},u.createElement(p,s({error:!!b,helperText:b?u.createElement("span",{className:x.helperText},b):null,className:x.input,InputProps:{endAdornment:u.createElement(f,{position:"end"},u.createElement(h,s({type:"submit"},c),l))}},E)))}function R(e){return u.createElement(B,s({placeholder:"New Todo",required:!0,IconButtonProps:{title:"Add Item"}},e),u.createElement(E,null))}const W=(e,t,n=JSON.stringify,r=JSON.parse)=>{const[o,a]=i.exports.useState(t);return i.exports.useEffect((()=>a((()=>{const n=window.localStorage.getItem(e);return null===n?t:r(n)}))),[e]),[o,t=>a((r=>{const o=t instanceof Function?t(r):t;return window.localStorage.setItem(e,n(o)),o}))]};function A({children:e}){const[t,n]=(e=>{const[t,n]=W("theme",e);return[i.exports.useMemo((()=>b({palette:{type:t}})),[t]),i.exports.useCallback((()=>n((e=>"dark"===e?"light":"dark"))),[n])]})(x("(prefers-color-scheme: dark)")?"dark":"light");return u.createElement(g,{theme:t},u.createElement(h,{title:("light"===t.palette.type?"Dark":"Light")+" mode",onClick:n},u.createElement(v,null)),u.createElement(O,null),e)}const F=d({wrapper:{display:"flex","& > *":{flex:"1"}},label:{display:"flex",alignItems:"center",paddingLeft:"1em"},code:{display:"flex",alignItems:"center"},button:{flex:"0"}});function V({code:e,setCode:t}){const n=F(),[r,o]=i.exports.useState(!1);return u.createElement(m,{className:n.wrapper},u.createElement(w,{component:"h1",className:n.label},"List Code:"),r?u.createElement(B,{IconButtonProps:{title:"Visit List"},defaultValue:e,onSubmission:e=>{t(e),o(!1)},autoFocus:!0},u.createElement(T,null)):u.createElement(w,{className:n.code},e),u.createElement(h,{className:n.button,onClick:()=>o((e=>!e)),title:r?"Cancel":"Edit List Code"},r?u.createElement(S,null):u.createElement(y,null)))}const q=e=>e.map((({created:e,updated:t,text:n,completed:r})=>({created:new Date(e),updated:null===t?t:new Date(t),completed:null===r?r:new Date(r),text:n}))),U="r2-todo-fullstack.herokuapp.com",z=window.location.protocol.includes("https"),G=`${window.location.protocol}//${U}`,H=()=>fetch(`${G}/api`,{credentials:"include"}).then((e=>e.ok)).catch((()=>!1)),K=(e,t)=>fetch(`${G}/api/${e}`,{credentials:"include",method:"POST",body:t}).then((e=>e.json())),Q=(e,t)=>fetch(`${G}/api/${e}`,{credentials:"include",method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>e.json())),X=(e,t)=>fetch(`${G}/api/${e}/${t.getTime()}`,{credentials:"include",method:"DELETE"}).then((()=>{})),Y=d({wrapper:{position:"absolute",top:"1em",right:"1em"}});function Z({code:e,serverOnline:t,realtime:n,realtimeMemberCount:r}){const o=Y();if(!t)return u.createElement("span",{className:o.wrapper,title:"Server Offline"},u.createElement(k,null));if(!e)return u.createElement("span",{className:o.wrapper,title:"On Private List"},u.createElement(C,null));if(!n)return u.createElement("span",{className:o.wrapper,title:"Synced"},u.createElement(P,null));const a=r-1;return u.createElement($,{className:o.wrapper,title:"Realtime"+(a?` - with ${a} other${a>1?"s":""}`:""),badgeContent:a},u.createElement(I,null))}const ee=u.lazy((()=>M((()=>import("./TodoItem.3acf5bdb.js")),["./assets/TodoItem.3acf5bdb.js","./assets/vendor.b8ad11ef.js"]))),te=(e,t,n)=>[...e.slice(0,t),n,...e.slice(t+1)],ne=(e,t)=>[...e.slice(0,t),...e.slice(t+1)],re=(e,t,n,r)=>{const[o,a]=W(`todos-${e}`,[],(e=>JSON.stringify((e=>e.map((({created:e,updated:t,text:n,completed:r})=>({created:e.getTime(),updated:t?t.getTime():null,completed:r?r.getTime():null,text:n}))))(e))),(e=>q(JSON.parse(e)))),[l,d]=i.exports.useState(""),u=i.exports.useMemo((()=>!e),[e]),m=((e,t,n,r,o,a,l)=>{const[s,c]=i.exports.useState(-1),d=i.exports.useRef(null);i.exports.useEffect((()=>{if(!n||!t)return;const s=new WebSocket(`ws${z?"s":""}://${U}/ws/${e}`,[Date.now().toString(),t]);return s.addEventListener("error",console.error),s.addEventListener("open",(()=>{d.current=s,l(!0),c(0)})),s.addEventListener("close",(e=>{var t;(null==(t=d.current)?void 0:t.protocol)===e.target.protocol&&(d.current=null,l(!1),c(-1))})),s.addEventListener("message",(e=>{const[t,n]=JSON.parse(e.data);switch(t){case"create":r(q([n])[0]);break;case"update":o(q([n])[0]);break;case"delete":a(new Date(n));break;case"memberCount":c(n);break;case"error":console.error("WS Error:",n)}})),()=>{d.current=null,s.close()}}),[e,n,t]);const u=(e,t)=>{var n;return null==(n=d.current)?void 0:n.send(JSON.stringify([e,t]))};return{connected:-1!==s,createTodo:e=>u("create",e),updateTodo:e=>u("update",e),deleteTodo:e=>u("delete",e.getTime()),memberCount:s}})(e,l,t&&!u,(e=>a((t=>[...t,e]))),(e=>a((t=>te(t,t.findIndex((t=>t.created.valueOf()===e.created.valueOf())),e)))),(e=>a((t=>ne(t,t.findIndex((t=>t.created.valueOf()===e.valueOf())))))),r),p=i.exports.useCallback((()=>u?Promise.resolve(!1):m.connected?Promise.resolve(!0):n()),[u,m.connected]);i.exports.useEffect((()=>{t&&!u&&(e=>fetch(`${G}/api/${e}`,{credentials:"include"}).then((e=>e.json())))(e).then((({csrf_token:e,todos:t})=>(d(e),q(t)))).then(a)}),[u,e,t]);return{todos:o,addTodo:i.exports.useCallback((t=>new Promise(((n,r)=>p().then((o=>a((l=>{if(l.find((({text:e})=>e===t)))return r(new Error("TODO already exists")),l;n();const s={created:new Date,updated:new Date,text:t,completed:null};return!o||u?[...l,s]:(m.connected?m.createTodo(t):K(e,t).then((e=>q([e])[0])).then((e=>a([...l,e]))),l)}))))))),[m.connected,u,e,a,K]),updateTodo:i.exports.useCallback(((t,n)=>new Promise(((r,o)=>p().then((l=>a((d=>{if(d.find((e=>t.valueOf()!==e.created.valueOf()&&e.text===n)))return o(Error("TODO already exists")),d;r();const i=new Date,p=d.findIndex((e=>e.created.valueOf()===t.valueOf())),f=c(s({},d[p]),{updated:i,text:n});return!l||u?te(d,p,f):(m.connected?m.updateTodo({created:t.getTime(),text:n}):Q(e,{created:t.getTime(),text:n}).then((e=>q([e])[0])).then((e=>a(te(d,p,e)))),d)}))))))),[m.connected,u,e,a,Q]),deleteTodo:i.exports.useCallback((t=>p().then((n=>a((r=>{const o=r.findIndex((e=>e.created.valueOf()===t.valueOf()));return!n||u?ne(r,o):(m.connected?m.deleteTodo(t):X(e,t).then((()=>a(ne(r,o)))),r)}))))),[m.connected,u,e,a,X]),toggleCompleted:i.exports.useCallback((t=>p().then((n=>a((r=>{const o=r.findIndex((e=>e.created.valueOf()===t.valueOf())),l=r[o].completed?null:new Date;return!n||u?te(r,o,c(s({},r[o]),{completed:l})):(m.connected?m.updateTodo({created:t.getTime(),completed:(null==l?void 0:l.getTime())||null}):Q(e,{created:t.getTime(),completed:(null==l?void 0:l.getTime())||null}).then((e=>q([e])[0])).then((e=>a(te(r,o,e)))),r)}))))),[m.connected,u,e,a,Q]),realtimeMemberCount:m.memberCount}};function oe(){const[e,t]=(()=>{const[e,t]=i.exports.useState(window.location.hash.slice(1));return[e,e=>t((t=>{const n=e instanceof Function?e(t):e;return window.history.pushState({},"","./#"+n),n}))]})();var n,r;n=e=>"Todos - "+(e?`#${e}`:"Local"),r=[e],i.exports.useEffect((()=>{document.title=n(...r)}),r);const[o,a]=(()=>{const[e,t]=i.exports.useState(null);return i.exports.useEffect((()=>{H().then(t)}),[]),[e,i.exports.useCallback((()=>H().then((e=>(t(e),e)))),[])]})(),[l,s]=i.exports.useState(!1),{todos:c,addTodo:d,updateTodo:m,deleteTodo:p,toggleCompleted:f,realtimeMemberCount:h}=re(e,!!o,a,s);return u.createElement(A,null,u.createElement(Z,{code:e,serverOnline:!!o,realtime:l,realtimeMemberCount:h}),u.createElement(N,{fixed:!0,maxWidth:"sm"},u.createElement(V,{code:e,setCode:t}),u.createElement(R,{onSubmission:d}),u.createElement(D,null,c.map((e=>u.createElement(i.exports.Suspense,{key:e.created.valueOf(),fallback:""},u.createElement(ee,{todo:e,onUpdate:m,onDelete:p,onToggle:f})))))))}L.render(u.createElement(u.StrictMode,null,u.createElement(oe,null)),document.getElementById("root"));export{M as _};
